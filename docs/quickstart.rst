
*********
Swak 활용
*********

여기서는 Swak의 활용 예를 통해 설명하겠다. 먼저 기본 용어부터 설명하겠다.

기본 용어
=========

- **데이터** - Swak은 기본적으로 **텍스트** 데이터를 다룬다.(만약 바이너리 데이터를 다루어야 한다면, 그것을 위한 플러그인을 통해 변환 후 가능할 것이다.) 내부적으로 Swak은 모든 텍스트를 **utf8** 로 인코딩하여 사용한다.
- **라인(행)** - 개행문자 ``\n`` 으로 분리되는 텍스트 데이터를 **라인** 또는 **행** 이라 한다.
- **레코드** - 라인을 의미 단위로 파싱한 결과물을 말한다. 레코드는 '키': '밸류' 형식, 즉 파이썬의 Dictonary 형식이다.
- **이벤트** - 레코드에 발생 시간 필드가 추가된 것을 이벤트 또는 **데이터 이벤트** 라고 한다.
- **태그** - 이벤트를 분류하기 위한 정보. 자세한 것은 :ref:`event_tag` 를 참고하자.
- **청크** - 버퍼는 레코드를 모아서 처리하는데, 이 단위를 청크라 한다.


사용해 보기
===========

설치가 끝났으면 간단하게 사용해보자.


커맨드 라인 명령
================

Swak은 커맨드라인에서 다양한 명령을 실행할 수 있다.

설치된 플러그인 리스트 보기
---------------------------

::

    swak list

특정 플러그인의 도움말 보기
---------------------------

::

    swak desc in.fakedata


간단히 테스트하기
-----------------

Swak은 정식 설정파일을 작성하기 전에 플러그인의 기능을 테스트할 수 있는 **테스트 커맨드** 를 지원한다. 테스트 커맨드는 유닉스 쉘 명령어 형식으로 사용한다. 다음의 예를 보자::

    swak run 'in.fakedata --type people | out.stdout'

파이프 기호 ``|`` 를 통해 플러그인이 연쇄적으로 동작한다. 예는 아래와 같은 일을 한다.

1. ``in.fackedata`` 플러그인으로 가짜 데이터를 생성
2. 표준 출력으로 출력

설정 파일
=========

설정 파일은 YAML(``*.yml``) 형식으로 Swak이 할 일을 명시한다. 샘플 설정 파일을 통해 Swak의 사용법을 살펴보자.

설정 파일에서 가장 핵심은 ``tags`` 필드이다. 이 아래에 여러 이벤트 태그가 필드로 등장한다. 각 태그는 하나 이상의 플러그인의 리스트로 구성된다.

미니멀한 설정 파일의 예
-----------------------

가짜 데이터를 표준 출력을 통해 출력하는 간단한 예를 살펴보자.

.. code-block:: yaml

    tags:
      foo:  # 이벤트 태그
        # 가짜 데이터 생성
        - in.fakedata -type people
        # 표준 출력으로 이벤트 보냄
        - out.stdout

위의 스크립트는 다음과 같은 식으로 이해하면 된다.

1. ``tags`` 아래 다양한 이벤트 태그를 선언한다.
2. ``foo`` 는 이벤트 태그로, 이벤트는 태그별로 처리된다.
3. ``in.fakedata`` 플러그인을 통해 생성된 가짜 데이터는 같은 태그의 다음 플러그인으로 보내진다.
4. 출력 플러그인 ``out.stdout`` 은 받은 데이터를 표준 출력으로 보낸다.

좀 더 복잡한 예
---------------

다음은 특정 파일을 테일링하여 Fluentd로 전송하는 설정 파일의 예이다. 조금 복잡하지만 순서대로 처리되기에 어려울 것은 없다.

.. code-block:: yaml

    tags:
      foo:  # 이벤트 태그
        # 주석행을 제거하며 대상 파일 테일링
        - in.filetail --path C:\myprj\logs\mylog.txt --posdir C:\swak_temp\pos --encoding: cp949 --exclude ^\S*#.*
        # 커스텀 포맷 파서
        - par.mylog
        # 5분 단위로 버퍼링
        - buf.file time --minute 5
        # Fluentd 전송
        - out.fluentd --server 192.168.0.1 --server: 169.168.0.2 --last /tmp/failed.txt --start_by: ip

1. ``in.filetail`` 은 지정된 파일에서 추가된 행을 보낸다.
2. ``par.mylog`` 는 행을 파싱하여 레코드 형태로 보낸다.
3. ``out.timebuffer`` 는 레코드를 버퍼에 쌓다가, 지정한 시간이 되었을 때 한 번씩 출력해 지나친 IO를 막아준다.
4. ``out.fluentd`` 플러그인은 버퍼에서 받은 데이터를 지정된 Fluentd 서버로 보낸다. 이때 하나 이상의 서버를 받고, 에러가 발생하면 다른 서버로 시도한다. 시작 출력은 ``start_by`` 로 지정하는 값에 의존하여 결정된다. 모든 출력이 실패하면 ``last`` 로 지정된 출력으로 이벤트를 보낸다.


다양한 경로를 거치는 처리
-------------------------

데이터가 항상 플러그인이 등장하는 순서대로 처리되는 것은 아니다. 새로운 태그의 지정을 통해 다양한 경로로 처리될 수 있다. 아래의 예를 살펴보자.

.. code-block:: yaml

    tags:
      detect:
        - out.exec --cmd "/usr/bin/r /etc/detect_abuse.r" --out /tmp/detected.tsv

      collect:
        - in.mysqltail --ip 127.0.0.1 --db logdb --table logtbl
        - buf.file size --lines 100 --tag detect

이 경우는 이 경우는 ``detect`` 태그에 인풋 플러그인이 없기에, ``collect`` 태그 부터 실행된다. 다음과 같은 순서이다.

1. ``in.mysqltail``
2. ``buf.file``
3. ``out.exec``

하나씩 살펴보자.

1. 먼저 ``collect`` 태그의 ``in.mysqltail`` 플러그인이 지정된 MySQL DB의 테이블에서 추가되는 행을 태그로 보낸다.
2. ``buf.file size`` 는 태그의 내용을 파일 버퍼에 쌓아두다가, 지정한 행 수가 되었을 때 모아서(청크) 다음 플러그인으로 전달해 지나친 IO 사용을 막아준다. 전달시에는 새로운 태그 ``detect`` 를 지정한다.
3. ``detect`` 태그에서 ``out.exec`` 플러그인은 버퍼링된 청크를 받고
4. 지정된 별도 프로세스에서 처리한 후, 그 결과를 출력 파일에 저장한다.

.. note:: 각 태그는 입력 플러그인이 있다면 등장 순서대로 시작되고, 없다면 매칭되는 이벤트가 있을 때 시작된다.


설정 파일 테스트
================

커스텀한 설정 파일을 테스트하는 경우를 생각해보자. ``my-swak-home`` 이라는 홈 디렉토리를 만들고, 그 안에 ``config.yml`` 을 원하는 형식으로 편집한다.

그 디렉토리로 들어가 아래와 같이 실행하면, 플러그인들은 메인 스레드에서 실행된다.(이를 테스트 모드라 하겠다.) 로그를 표준 출력으로 볼 수 있으며, 코드에 중단점을 설정할 수 있어 디버깅에 용이하다::

    swak test


테스트 모드에서는 하나의 기본 태그로만 이벤트를 다룰 수 있다. 설정 파일에 태그가 여럿있다면, 아래와 같이 실행할 태그를 지정하자. (지정하지 않으면 최초로 등장하는 태그가 선택)::

    swak test --tag foo  # foo 태그에 대해 테스트


외부 플러그인 설치
==================


필요한 플러그인을 GitHub에서 찾아 설치한다. Swak의 외부 플러그인은 ``swak-`` 으로 시작한다. 여기서는 이벤트를 Fluentd로 전달하는 출력 플러그인을 설치해보겠다.


코드 받기
---------

먼저 Swak 소스 코드 디렉토리 아래 ``plugins`` 디렉토리로 이동하고::

    cd swak/plugins

사용할 외부 플러그인을 ``clone`` 한다::

    git clone https://github.com/haje01/swak-fluentd.git fluentd

마지막 인자로 ``swak-`` 을 제외한 플러그인 이름만을 디렉토리 명으로 추가한 것에 주의하자. 이렇게 하면 ``plugins`` 아래 ``fluentd`` 디렉토리에 플러그인 코드가 받아진다.

다음과 같이 설치된 것을 확인할 수 있다::

    Swak has 2 plugin(s):
    +------------+----------------------------+
    | Plugin     | Description                |
    |------------+----------------------------|
    | in.counter | Emit incremental number.   |
    | out.stdout | Output to standard output. |
    +------------+----------------------------+

플러그인에 따라 의존 패키지 설치가 필요할 수 있다.(자세한 것은 해당 플러그인의 ``README.md`` 를 참고하자.)


의존 패키지 설치
----------------

플러그인 디렉토리에 ``requirements.txt`` 가 있다면 플러그인이 의존하는 외부 패키지가 있다는 뜻이다. 해당 디렉토리로 이동 후 다음과 같이 설치해주자::

    pip install -r requirements.txt


실행
----


설치된 플러그인은 Swak 기동시에 자동으로 등록되고, 실행할 수 있다.

