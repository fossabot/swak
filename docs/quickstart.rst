
************
Swak 활용 예
************

설치가 끝났으면 간단하게 사용해보자.


커맨드 라인 명령
================

Swak은 커맨드라인에서 다양한 명령을 실행할 수 있다.

설치된 플러그인 리스트 보기
---------------------------

::

    swak list

특정 플러그인의 도움말 보기
---------------------------

::

    swak desc in.fakedata


간단히 테스트하기
-----------------

::

    swak run 'in.fakedata --type people | out.Stdout'

설정 파일
=========

설정 파일은 YAML(``*.yml``) 형식으로 Swak이 할 일을 명시한다. 샘플 설정 파일을 통해 Swak의 사용법을 살펴보자.

설정 파일에서 가장 핵심은 ``streams`` 필드이다. 이 아래에 여러 데이터 스트림이 그것의 태그명을 필드로 등장한다. 각 데이터 스트림은 하나 이상의 플러그인으로 구성된다.

미니멀한 설정 파일의 예
-----------------------

가짜 데이터를 표준 출력을 통해 출력하는 간단한 예를 살펴보자.

.. code-block:: yaml

    streams:
      foo:  # 데이터 스트림 태그
        # 가짜 데이터 생성
        - in.fakedata -type people
        # 표준 출력으로 스트림 보냄
        - out.stdout

위의 스크립트는 다음과 같은 식으로 이해하면 된다.

1. ``streams`` 아래 다양한 데이터 스트림을 선언한다.
2. ``foo`` 는 데이터 스트림의 태그로, 데이터 스트림을 칭할 때 사용된다.
3. ``in.fakedata`` 플러그인을 통해 생성된 가짜 데이터는 ``foo`` 데이터 스트림으로 보낸다.
4. ``foo`` 데이터 스트림의 ``output`` 플러그인인 ``out.stdout`` 플러그인은 데이터 스트림에서 받은 데이터를 표준 출력으로 보낸다.

좀 더 복잡한 예
---------------

다음은 특정 파일을 테일링하여 Fluentd로 전송하는 설정 파일의 예이다. 조금 복잡하지만 순서대로 처리되기에 어려울 것은 없다.

.. code-block:: yaml

    streams:
      foo:  # 데이터 스트림 태그
        # 주석행을 제거하며 대상 파일 테일링
        - in.filetail --path C:\myprj\logs\mylog.txt --posdir C:\swak_temp\pos --encoding: cp949 --exclude ^\S*#.*
        # 커스텀 포맷 파서
        - par.mylog
        # 5분 단위로 버퍼링
        - buf.file time --minute 5
        # Fluentd 전송
        - out.fluentd --server 192.168.0.1 --server: 169.168.0.2 --last /tmp/failed.txt --start_by: ip

1. ``in.filetail`` 은 지정된 파일에서 추가된 행을 스트림으로 보낸다.
2. ``par.mylog`` 는 행을 파싱하여 레코드 형태로 스트림에 보낸다.
3. ``out.timebuffer`` 는 스트림의 레코드를 버퍼에 쌓다가, 지정한 시간이 되었을 때 한 번씩 출력해 지나친 IO를 막아준다.
4. ``out.fluentd`` 플러그인은 스트림을 지정된 Fluentd 서버로 보낸다. 이때 하나 이상의 서버를 받고, 에러가 발생하면 다른 서버로 시도한다. 시작 출력은 ``start_by`` 로 지정하는 값에 의존하여 결정된다. 모든 출력이 실패하면 ``last`` 로 지정된 출력으로 스트림을 보낸다.


처리 순서가 순환적인 예
-----------------------

항상 데이터가 플러그인이 등장하는 순서대로 처리되는 것은 아니다. 새로운 태그의 지정을 통해 다양한 데이터 스트림을 오가면서 처리될 수 있다. 아래의 예를 살펴보자.

.. code-block:: yaml

    streams:
      detect:
        - tr.exec --cmd "/usr/bin/r /etc/detect_abuse.r"
        - out.stdout

      collect:
        - in.mysqltail --ip 127.0.0.1 --db logdb --table logtbl
        - buf.file size --lines 100 --tag detect

이 경우는 이 경우는 ``detect`` 스트림에 인풋 플러그인이 없기에, 다음과 같은 순서대로 실행된다.

1. ``in.mysqltail``
2. ``buf.file``
3. ``tr.exec``
4. ``out.stdout``

하나씩 살펴보자.

1. 먼저 ``in.mysqltail`` 플러그인은 지정된 MySQL DB의 테이블에서 추가되는 행을 스트림으로 보낸다.
2. ``buf.file size`` 는 스트림의 내용을 파일 버퍼에 쌓아두다가, 지정한 행 수가 되었을 때 모아서 다음 플러그인으로 전달해 지나친 IO 사용을 막아준다. 전달시에는 새로운 스트림 ``detect`` 로 보낸다.
3. 거기에서 ``tr.exec`` 플러그인은 버퍼링된 청크를 받고, 지정된 별도 프로세스에서 처리한 후, 그 결과를 임시 파일로 받는다.
4. 같은 태그에 관해서는 등장 순서대로 처리되기에, 받은 결과는 ``out.stdout`` 으로 보내진다.

.. note:: 각 스트림은 입력 플러그인이 있다면 등장 순서대로 시작되고, 없다면 스트림에 매칭되는 데이터가 있을 때 시작된다.


설정 파일 테스트
================

커스텀한 설정 파일을 테스트하는 경우를 생각해보자. ``my-swak-home`` 이라는 홈 디렉토리를 만들고, 그 안에 ``config.yml`` 을 원하는 형식으로 편집한다.

그 디렉토리로 들어가 아래와 같이 실행하면, 플러그인들은 메인 스레드에서 실행된다.(이를 테스트 모드라 하겠다.) 로그를 표준 출력으로 볼 수 있으며, 코드에 중단점을 설정할 수 있어 디버깅에 용이하다::

    swak test


테스트 모드에서는 하나의 데이터 스트림만 실행할 수 있다. 설정 파일에 데이터 스트림이 여럿있다면, 아래와 같이 실행할 데이터 스트림의 태그를 지정하자. (지정하지 않으면 최초로 등장하는 데이터 스트림이 선택)::

    swak test --tag foo  # foo 데이터 스트림에 대해 테스트


외부 플러그인 설치
==================


필요한 플러그인을 GitHub에서 찾아 설치한다. Swak의 외부 플러그인은 ``swak-`` 으로 시작한다. 여기서는 스트림을 Fluentd로 전달하는 출력 플러그인을 설치해보겠다.


코드 받기
---------

먼저 Swak 소스 코드 디렉토리 아래 ``plugins`` 디렉토리로 이동하고::

    cd swak/plugins

사용할 외부 플러그인을 ``clone`` 한다::

    git clone https://github.com/haje01/swak-fluentd.git fluentd

마지막 인자로 ``swak-`` 을 제외한 플러그인 이름만을 디렉토리 명으로 추가한 것에 주의하자. 이렇게 하면 ``plugins`` 아래 ``fluentd`` 디렉토리에 플러그인 코드가 받아진다.

다음과 같이 설치된 것을 확인할 수 있다::

    Swak has 2 plugin(s):
    +------------+----------------------------+
    | Plugin     | Description                |
    |------------+----------------------------|
    | in.counter | Emit incremental number.   |
    | out.stdout | Output to standard output. |
    +------------+----------------------------+

플러그인에 따라 의존 패키지 설치가 필요할 수 있다.(자세한 것은 해당 플러그인의 ``README.md`` 를 참고하자.)


의존 패키지 설치
----------------

플러그인 디렉토리에 ``requirements.txt`` 가 있다면 플러그인이 의존하는 외부 패키지가 있다는 뜻이다. 해당 디렉토리로 이동 후 다음과 같이 설치해주자::

    pip install -r requirements.txt


실행
----


설치된 플러그인은 Swak 기동시에 자동으로 등록되고, 실행할 수 있다.

